# Epic E004: Multi-Agent Video Generation Pipeline

## Overview
Implement orchestrated multi-agent system that transforms user briefs into complete video ads through specialized AI agents handling story structure, style consistency, prompt synthesis, safety validation, and continuity.

## Business Value
- Core differentiator: end-to-end automation
- Ensures brand consistency across all scenes
- Maintains visual coherence through continuity agent
- Reduces generation failures through safety validation
- Enables scalable video production

## Success Criteria
- [ ] Creative Bible generated from user brief in <30 seconds
- [ ] 4 reference images generated via DALL-E in <60 seconds
- [ ] 5-scene storyboard created in <15 seconds
- [ ] Sora prompts synthesized with continuity in <10 seconds
- [ ] Safety validation blocks unsafe content 100% of time
- [ ] Visual consistency maintained across all 5 scenes
- [ ] Generation success rate >90%

## Dependencies
- **Text Models** (Replicate): Llama 3.1, Mistral, or Claude via Replicate
- **Image Models** (Replicate): FLUX, Stable Diffusion XL, Playground v2.5
- **Video Models** (Replicate): Minimax Video-01, Luma Dream Machine, Runway Gen-3
- **Audio Models** (Replicate): Suno, MusicGen, AudioCraft
- Project management (E002)
- Creative brief chat (E003)

## Priority
**P0 - MVP Critical**

## Estimated Effort
**10-14 days** (3 backend engineers)

## Related Stories
- S020: Style & Brand Consistency Agent
- S021: Story Structuring Agent (Text Models - Llama/Mistral)
- S022: Safety Validation Agent (Text Models - Llama Guard)
- S023: Prompt Synthesis Agent (Text Models)
- S024: Continuity Back-Propagation Agent
- S025: Creative Bible Data Model
- S026: Reference Image Generation (Image Models - FLUX/SDXL)
- S027: Parallel Scene Generation (Video Models - Minimax/Luma)
- S028: API Retry Logic & Error Handling
- S062: Replicate Model Abstraction Layer
- S063: Multi-Model Fallback Strategy

## Agent Architecture
```
Master Orchestrator
    ├── Story Structuring Agent
    ├── Style & Brand Agent
    ├── Safety Validation Agent
    ├── Prompt Synthesis Agent
    └── Continuity Agent
```

## Agent Responsibilities

### 1. Style & Brand Agent
**Input**: User brief + product images  
**Output**: Creative Bible with style parameters  
**Processing Time**: 30 seconds  
**Models Used**: Llama 3.1 70B (Replicate) or Mistral Large

```json
{
  "brand_style": "modern minimalist",
  "vibe": "calm and serene",
  "colors": ["#8B7355", "#F5E6D3", "#4A4A4A", "#FFFFFF"],
  "lighting": "soft natural morning light",
  "camera": "smooth, slow dolly movements",
  "motion": "slow, refined",
  "energy_level": 4,
  "image_model": "flux-1.1-pro",
  "video_model": "minimax-video-01"
}
```

### 2. Story Structuring Agent
**Input**: User brief + scenes  
**Output**: 5-scene storyboard  
**Processing Time**: 15 seconds  
**Models Used**: Llama 3.1 70B or Mistral Large (Replicate)

```json
{
  "scenes": [
    {
      "scene_index": 1,
      "scene_title": "Morning Awakening",
      "description": "Close-up of product...",
      "duration_seconds": 6,
      "role_in_story": "setup",
      "camera_direction": "Static push-in",
      "emotion_tone": "calm, inviting",
      "image_prompt": "Generated by Llama 3.1",
      "video_prompt": "Optimized for Minimax Video-01"
    }
  ]
}
```

### 3. Safety Validation Agent
**Input**: All scene descriptions + prompts  
**Output**: Approval or block with alternatives  
**Processing Time**: 5 seconds  
**Models Used**: Llama Guard 3 (Replicate) for content moderation

Blocks: violence, nudity, drugs, hate, deepfakes, copyright

**Llama Guard Integration**:
- Dedicated safety model trained for content moderation
- Categorizes violations into 13 safety categories
- Provides confidence scores and explanations

### 4. Prompt Synthesis Agent
**Input**: Scene + Creative Bible + reference images  
**Output**: Complete video generation prompts  
**Processing Time**: 10 seconds  
**Models Used**: 
- Text: Llama 3.1 70B for prompt optimization
- Image: FLUX 1.1 Pro or SDXL for reference images
- Video: Minimax Video-01 or Luma Dream Machine

### 5. Continuity Agent
**Input**: Previous scene last frame + next scene prompt  
**Output**: Updated prompt with continuity instructions  
**Processing Time**: 5 seconds per scene

## Technical Implementation

### Creative Bible Caching
- Store Creative Bible per project
- Reuse for subsequent ads (40% cost savings)
- Allow override for style changes

### Parallel Generation
```python
async def generate_video_scenes(prompts, creative_bible):
    # Generate all 5 scenes + music in parallel
    tasks = [
        sora.generate(prompts[0]),
        sora.generate(prompts[1]),
        sora.generate(prompts[2]),
        sora.generate(prompts[3]),
        sora.generate(prompts[4]),
        suno.generate_music(music_prompt)
    ]
    results = await asyncio.gather(*tasks)
    return results
```

### Continuity Back-Propagation
```python
for i, scene in enumerate(scenes):
    if i > 0:
        # Extract last frame of previous scene
        last_frame = extract_frame(scenes[i-1]['url'], -1)
        
        # Inject into next scene prompt
        prompts[i] = continuity_agent.enhance_prompt(
            prompts[i],
            last_frame_url=last_frame,
            previous_scene_info=scenes[i-1]
        )
```

## Error Handling
- Retry failed generations up to 3 times
- Exponential backoff: 30s, 60s, 120s
- Fallback to simplified prompts if all retries fail
- Log all failures for analysis

## Cost Optimization
- Cache Creative Bibles: Save $0.40/video
- Batch reference images: 4 parallel calls
- Reuse reference images: Save $0.40/video
- Smart prompt caching where possible

## Success Metrics
- Creative Bible generation success: >99%
- Reference image quality: >90% user satisfaction
- Scene generation success: >90%
- Visual consistency score: >85%
- Average generation time: <5 minutes
- Cost per video: <$2.50

---
**Created**: 2025-11-15  
**Status**: Draft  
**Owner**: Backend AI Team
